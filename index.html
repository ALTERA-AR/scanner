<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>

  <!--Foto-->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }

    #boton-foto {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      font-size: 16px;
      background-color: #ff4081;
      color: white;
      border: none;
      border-radius: 8px;
      z-index: 10;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <!-- Bot√≥n para capturar -->
  <button id="boton-foto">.</button>


  <a-scene mindar-image="imageTargetSrc:src/traks/targets.mind;  missTolerance: 15" vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">
    <a-assets>
      <a-asset-item id="Animacion0" src="src/model/animal/Medusa.glb"></a-asset-item>
      <a-asset-item id="Animacion1" src="src/model/animal/Frog.glb"></a-asset-item>
      <a-asset-item id="Animacion2" src="src/model/animal/Snake.glb"></a-asset-item>
      <a-asset-item id="Animacion3" src="src/model/cute/Ajolote.glb"></a-asset-item>
      <audio id="audioRA" src="src/media/Ajolote_Dudoso.mp3" loop="false"></audio>
      <a-asset-item id="Animacion4" src="src/model/cute/Frog-Pride-2.glb"></a-asset-item>
      <a-asset-item id="Animacion5" src="src/model/cute/Cute_Cat.glb"></a-asset-item>
      <a-asset-item id="Animacion6" src="src/model/trill/Head.glb"></a-asset-item>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0">
      <a-gltf-model rotation="180 0 180" position="0 0.3 0" scale="0.7 0.7 0.7" src="#Animacion0" animation-mixer>
      </a-gltf-model>
    </a-entity>

    <a-entity mindar-image-target="targetIndex: 1">
      <a-gltf-model rotation="0 0 0" position="1 1 0" scale="0.5 0.5 0.5" src="#Animacion1" animation-mixer>
      </a-gltf-model>
    </a-entity>

    <!-- targetIndex 2 para Snake -->
    <a-entity id="anchor2" mindar-image-target="targetIndex: 2">
      <a-gltf-model id="modelo-temp" src="#Animacion2" rotation="180 90 180" position="2 0 0" scale="0.09 0.09 0.09"
        animation-mixer> </a-gltf-model>
    </a-entity>
    <!-- ajolote -->
    <a-entity id="anchor3" mindar-image-target="targetIndex: 3">
      <a-gltf-model id="modelo-temp" src="#Animacion3" rotation="0 0 0" position="0 -.5 0" scale="1 1 1"
        animation-mixer> </a-gltf-model>
    </a-entity>

    <a-entity id="anchor2" mindar-image-target="targetIndex: 4">
      <a-gltf-model id="modelo-temp" src="#Animacion4" rotation="0 0 0" position="0 -.5 0" scale="1 1 1"
        animation-mixer> </a-gltf-model>
    </a-entity>

    <a-entity mindar-image-target="targetIndex: 5">
      <a-gltf-model rotation="0 180 0" position="0 0 0" scale="0.1 0.1 0.1" src="#Animacion5" animation-mixer>
      </a-gltf-model>
    </a-entity>

    <a-entity id="anchor2" mindar-image-target="targetIndex: 6">
      <a-gltf-model id="modelo-temp" src="#Animacion6" rotation="0 0 0" position="0 -3 0" scale="2 2 2"
        animation-mixer> </a-gltf-model>
    </a-entity>
    </a-entity>

    <!-- contenedor para el modelo liberado -->
    <a-entity id="modelo-libre" visible="false"></a-entity>
  </a-scene>

  <!-- Script para liberar el modelo -->
  <script>
    AFRAME.registerComponent('liberar-modelo', {
      init: function () {
        const anchor = document.querySelector('#anchor2');
        const modeloTemp = document.querySelector('#modelo-temp');
        const modeloLibre = document.querySelector('#modelo-libre');

        anchor.addEventListener('targetFound', () => {
          if (modeloLibre.hasChildNodes()) return; // Evita m√∫ltiples clones

          const nuevoModelo = modeloTemp.cloneNode(true);
          nuevoModelo.setAttribute('position', '0 0 -1'); // frente a la c√°mara
          nuevoModelo.setAttribute('scale', '0.09 0.09 0.09');
          nuevoModelo.setAttribute('animation-mixer', '');

          modeloLibre.appendChild(nuevoModelo);
          modeloLibre.setAttribute('visible', 'true');
          anchor.setAttribute('visible', 'false');
        });
      }
    });

    // Activa el componente
    document.querySelector('a-scene').setAttribute('liberar-modelo', '');
  </script>
  <!-- Script para capturar pantalla visible -->
  <script>
    document.getElementById('boton-foto').addEventListener('click', () => {
      html2canvas(document.body, {
        useCORS: true,
        allowTaint: true
      }).then(canvas => {
        const link = document.createElement('a');
        link.download = 'captura_RA.png';
        link.href = canvas.toDataURL();
        link.click();
      });
    });
  </script>


  <!--sonido anchor 3-->
  <script>
    const anchor = document.querySelector('#anchor3');
    const audio = document.querySelector('#audioRA');

    anchor.addEventListener('targetFound', () => audio.play());
    anchor.addEventListener('targetLost', () => {
      audio.pause();
      audio.currentTime = 6;
    });
  </script>

   <style>
      #controls {
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        z-index: 999;
      }
      button {
        background: rgba(0,0,0,0.6);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <a-scene mindar-image="imageTargetSrc: ./targets.mind;" 
             embedded 
             color-space="sRGB"
             renderer="colorManagement: true, physicallyCorrectLights" 
             vr-mode-ui="enabled: false"
             device-orientation-permission-ui="enabled: false">

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- Ejemplo: modelo -->
      <a-entity mindar-image-target="targetIndex: 0">
        <a-gltf-model src="#modelo" scale="0.1 0.1 0.1" position="0 0 0"></a-gltf-model>
      </a-entity>
    </a-scene>

    <!-- Controles -->
    <div id="controls">
      <button id="zoomIn">Zoom +</button>
      <button id="zoomOut">Zoom ‚àí</button>
      <button id="foto">üì∑ Foto</button>
      <button id="videoStart">‚è∫ Grabar</button>
      <button id="videoStop" style="display:none;">‚èπ Detener</button>
    </div>

    <script>
      let videoTrack;
      let currentZoom = 1;
      let mediaRecorder;
      let chunks = [];

      // Esperar a que MindAR inicialice la c√°mara
      document.querySelector("a-scene").addEventListener("renderstart", () => {
        const mindarComponent = document.querySelector("a-scene").systems["mindar-image"];
        const stream = mindarComponent.video.srcObject;
        videoTrack = stream.getVideoTracks()[0];
      });

      // Zoom +
      document.getElementById("zoomIn").onclick = () => {
        if (!videoTrack) return;
        currentZoom += 0.5;
        videoTrack.applyConstraints({ advanced: [{ zoom: currentZoom }] }).catch(console.error);
      };

      // Zoom ‚àí
      document.getElementById("zoomOut").onclick = () => {
        if (!videoTrack) return;
        currentZoom = Math.max(1, currentZoom - 0.5);
        videoTrack.applyConstraints({ advanced: [{ zoom: currentZoom }] }).catch(console.error);
      };

      // Foto
      document.getElementById("foto").onclick = () => {
        const canvas = document.querySelector("a-scene").components.screenshot.getCanvas("perspective");
        const link = document.createElement("a");
        link.href = canvas.toDataURL("image/png");
        link.download = "captura.png";
        link.click();
      };

      // Grabar video
      document.getElementById("videoStart").onclick = () => {
        const canvasStream = document.querySelector("a-scene").components.screenshot.getCanvas("perspective").captureStream(30);
        mediaRecorder = new MediaRecorder(canvasStream);
        chunks = [];

        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = () => {
          const blob = new Blob(chunks, { type: "video/mp4" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "grabacion.mp4";
          a.click();
        };

        mediaRecorder.start();
        document.getElementById("videoStart").style.display = "none";
        document.getElementById("videoStop").style.display = "inline";
      };

      // Detener grabaci√≥n
      document.getElementById("videoStop").onclick = () => {
        mediaRecorder.stop();
        document.getElementById("videoStart").style.display = "inline";
        document.getElementById("videoStop").style.display = "none";
      };
    </script>
</body>


</html>
